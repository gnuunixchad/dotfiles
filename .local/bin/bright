#!/usr/bin/sh
# bright
# @author nate zhou
# @since 2025
# @depends brightnessctl

#set -x
WOBFIFO="${XDG_RUNTIME_DIR}/wob.fifo"
# save brightness to XDG_CACHE_DIR for reboot consistency
BRIGHTNESS="${XDG_CACHE_HOME}/brightness.level"
DAMBLOCKS="${XDG_RUNTIME_DIR}/damblocks.pid"

parseBrightness() {
    grep 'Current brightness' \
            | tr '()' ' ' | cut -d' ' -f5 | sed 's/%//' \
            | tee "$WOBFIFO" "$BRIGHTNESS" \
        && kill -38 "$(cat $DAMBLOCKS)";
}

# don't direct to WOBFIFO if brightness change is triggered by an idle manager.
parseBrightnessIdle() {
    grep 'Current brightness' \
            | tr '()' ' ' | cut -d' ' -f5 | sed 's/%//' > "$BRIGHTNESS" \
        && kill -38 "$(cat $DAMBLOCKS)";
}

changeBrightness() {
    brightnessctl set "$1" | parseBrightness
}

while [ -n "$1" ]; do
    case "$1" in
        --minus)
            changeBrightness '1%-'
            ;;
        --minus10)
            changeBrightness '10%-'
            ;;
        --plus)
            changeBrightness '1%+'
            ;;
        --plus10)
            changeBrightness '10%+'
            ;;
        --max)
            changeBrightness '100%'
            ;;
        --min)
            changeBrightness '0%'
            ;;
        --no-fifo)
            brightnessctl | parseBrightnessIdle
            return
            ;;
    esac
    shift
done

[ -z "$1" ] && brightnessctl | bright_parse
