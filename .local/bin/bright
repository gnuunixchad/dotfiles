#!/usr/bin/sh
# bright
# @author nate zhou
# @since 2025

#set -x
WOBFIFO="${XDG_RUNTIME_DIR}/wob.fifo"
BRIGHTNESS="${XDG_CACHE_HOME}/brightness.level" # save to XDG_CACHE_DIR for reboot consistency

bright_parse() {
    grep 'Current brightness' | tr '()' ' ' | cut -d' ' -f5 | sed 's/%//' | tee "$WOBFIFO" "$BRIGHTNESS" && kill -38 "$(cat ${XDG_RUNTIME_DIR}/damblocks.pid)";
}

bright_parse_no_fifo() {
    grep 'Current brightness' | tr '()' ' ' | cut -d' ' -f5 | sed 's/%//' > "$BRIGHTNESS" && kill -38 "$(cat ${XDG_RUNTIME_DIR}/damblocks.pid)";
}

changeBrightness() {
    brightnessctl set "$1" | bright_parse
}

while [ -n "$1" ]; do
    case "$1" in
        --minus)
            changeBrightness '1%-'
            ;;
        --plus)
            changeBrightness '1%+'
            ;;
        --no-fifo)
            brightnessctl | bright_parse_no_fifo
            return
            ;;
    esac
    shift
done

[ -z "$1" ] && brightnessctl | bright_parse
