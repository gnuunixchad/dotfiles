#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025,2026
# decrypt the gpg encrypted image file and pipe to a viewer without writing to
# the disk

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    menu="${HOME}/.local/bin/wmenu-color"
elif [ -n "$XAUTHORITY" ]; then
    menu="dmenu"
fi

usage() {
    cat << _EOF_
USAGE
        $(basename "$0") FILE
_EOF_
}

[ "$#" -eq 0 ] && (usage; exit 0)

gpg_passphrase=$(echo "" | $menu-P -p "[$(basename $0)] passphrase:")

[ -z "$gpg_passphrase" ] && exit 1

case "$1" in
    *.pdf.gpg)
        echo "$gpg_passphrase" \
            | gpg --no-symkey-cache --batch --passphrase-fd 0 -d "$1" \
            | zathura -
        ;;
    *.gif.gpg)
        echo "$gpg_passphrase" \
            | gpg --no-symkey-cache --batch --passphrase-fd 0 -d "$1" \
            | swayimg -
        ;;
    *)
        echo "$gpg_passphrase" \
            | gpg --no-symkey-cache --batch --passphrase-fd 0 -d "$1" \
            | mpv - --loop --no-resume-playback
        ;;
esac
