#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025
# decrypt the .gpg file and pipe to tar
# if in wayland, using wmenu as input box
# after reading the untar'ed files, remember to `shred -u <files>`

source ${HOME}/.local/bin/wmenu-color 2>/dev/null

CIPHER_ALGO=aes256
usage() {
    cat << _EOF_
USAGE
        $(basename "$0") FILE

Make an encrypted tarball with symmetric cipher $CIPHER_ALGO using wmenu for input
_EOF_
}

[ "$#" -eq 0 ]; (usage; exit 1)

if [ "$XDG_SESSION_TYPE" = "tty" ]; then
    tar -cvf - "$1" | gpg --no-symkey-cache -c --cipher-algo aes-256 --output "$1".tar.gpg
    exit 0
fi

gpg_passphrase1=$(echo "" | wmenu-color -P -p "[$(basename $0)] passphrase: ")

if  [ -z "$gpg_passphrase1" ]; then
    notify-send -r 1284 -u low "$(basename $0):" "Aborted for empty passphrase"
    exit 1
fi
gpg_passphrase2=$(echo "" | wmenu-color -P -p "[$(basename $0)] passphrase again ")
if [ "$gpg_passphrase1" != "$gpg_passphrase2" ]; then
    notify-send -r 1284 -u low "inputs are not identical!"
    exit 1
fi

tar -cvf - "$1" | gpg --no-symkey-cache -c --cipher-algo "$CIPHER_ALGO" --output "$1".tar.gpg --passphrase "$gpg_passphrase1"


[ "$XDG_SESSION_TYPE" != "tty" ] && notify-send -u low -r 1099 "$(basename $0)" "$msg"
