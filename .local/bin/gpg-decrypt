#!/usr/bin/sh
# @author nate zhou
# @since 2025
# decrypt the .gpg file
# if in wayland, using wmenu as input box

source $HOME/.local/bin/wmenu-color 2>/dev/null

fileName="$(echo "$1" | sed -E 's/.gpg$//')"

# output redirection shan't overwrite an existing file
if [ -f "$fileName" ]; then
    PROMPT="$fileName already exists, choose another name: "
    if [ "$XDG_SESSION_TYPE" = "tty" ]; then
        printf "$PROMPT"
        read -r fileName
    else
        fileName="$(wmenu-color -p "$PROMPT" < /dev/null)"
    fi
fi

if [ "$XDG_SESSION_TYPE" = "tty" ]; then
    gpg --no-symkey-cache --pinentry-mode loopback -d "$1" > "$fileName"
    exit 0
fi

gpg_passphrase=$(echo "" | wmenu-color -P -p "[$(basename $0)] passphrase: ")

# don't do anything if exiting wmenu without any input
if  [ -z "$gpg_passphrase" ]; then
    exit 1
fi

echo "$gpg_passphrase" \
        | gpg --no-symkey-cache --batch --passphrase-fd 0 -d "$1" \
        > "$fileName" \
    && msg="Done" \
    || (rm "$fileName"; \
        msg="Failed")

[ "$XDG_SESSION_TYPE" != "tty" ] && notify-send -u normal "$(basename $0)" "$msg"

#gpg-connect-agent reloadagent /bye
