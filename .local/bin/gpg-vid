#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025,2026
# @depends gpg wmenu dmenu(xorg, with password patch)
# decrypt the .gpg file and pipe to mpv, without writing to the disk
# the video file has to be streamable, triming a mp4 file with ffmpeg could make it non-streamable
# fix it by copy the movflags of the orgianl file
# ffmpeg -i output.mp4 -c copy -movflags faststart new_output.mp4

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    menu="${HOME}/.local/bin/wmenu-color"
elif [ -n "$XAUTHORITY" ]; then
    menu="dmenu"
fi

usage() {
    cat << _EOF_
USAGE
        $(basename "$0") FILE
_EOF_
}
[ $# -eq 0 ] && (usage; exit 1)

gpg_passphrase=$(echo "" | $menu -P -p "[$(basename $0)] passphrase:")

[ -z "$gpg_passphrase" ] && exit 1

echo "$gpg_passphrase" \
    | gpg  --no-symkey-cache --batch --passphrase-fd 0 -d "$1" \
    | mpv - --loop --no-resume-playback
