#!/usr/bin/sh
# @author nate zhou
# @since 2023,2024,2025,2026
# @depends: libnotify, dunst(or equivalent daemon)
# wttr - weather report script

# TODO:
# - cronjob function

CITY="${HOME}/.cache/city"
WTTR="${HOME}/.cache/wttr"

usage() {
    cat << _EOF_
USAGE
            $(basename $0) [CITY] [OPTION]
            without CITY, read the local cache in $WTTR
OPTIONS
            -u,--update     update the local cache in $WTTR
            -c,--cron [interval]
                            to be run as a cron job that checks the last update
                            time withthe defined update intervals(default 3600)
            -e,--edit       edit the CITY in $CITY
            -h,--help       print this usage manual
_EOF_
    exit 0
}

notify() {
    msg="$1"

    [ "$XDG_SESSION_TYPE" != "tty" ] && notify-send -r 23 "$(basename $0)" "$msg"
}

abort() {
    msg="$1"

    RED='\033[0;31m'
    RESET='\033[0m'

    echo "${RED}${1}${RESET}"

    notify "$msg" >&2
    exit 1
}

check_city() {
    wttr=$(cat $WTTR 2>/dev/null)

    if [ ! -f "$CITY" ]; then
        msg="$CITY doesn't exist, try \"$(basename $0) -e\" first."
        abort "$msg"
    elif [ -z "$wttr" ]; then
        msg="$WTTR is empty, try \"$(basename $0) -u\" first."
        abort "$msg"
    fi
}

get_local_wttr() {
    check_city

    wttr=$(cat $WTTR)
    msg="$wttr"
    echo "$msg"
    notify "$msg"

}

get_city_wttr() {
    city="$1"
    msg=$(curl wttr.in/${city}?format=4)
    echo "$msg"
    notify "$msg"
}

edit_city() {
    $EDITOR $CITY
}

update() {
    city="$(cat $CITY)"
    msg=$(curl wttr.in/${city}?format=4)
    echo "$msg" | tee $WTTR
    notify "$msg"
}

[ -z "$1" ] && get_local_wttr

if [ -n "$1" ]; then
    case "$1" in
        -u|--update) update ;;
        -c|--cron) cron ;;
        -e|--edit) edit_city ;;
        -h|--help) usage ;;
        *) get_city_wttr "$1" ;;
    esac
fi
