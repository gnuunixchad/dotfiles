#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025
# capture - select output and audio source for screen casting via danymic menu

CAPTURE_HOME="${HOME}/tmp/capture"
[ -d "$CAPTURE_HOME" ] || mkdir -p $CAPTURE_HOME

FPS=30
filename="${CAPTURE_HOME}/$(date +%Y-%m-%d_%H_%M_%S)"
extension="mp4"

usage() {
    cat <<_EOF_
USAGE
        $(basename $0) [OPTION]...
        Select output and audio source for screen casting via danymic menu.
        Default fomart is mp4 in 30FPS
OPTIONS
        -60     record in 60FPS
        -mkv    record in mkv
        -mute   record without audio
_EOF_

exit 0
}

notify() {
    echo "${RED}${1}${RESET}"
    [ "$XDG_SESSION_TYPE" != "tty" ] && notify-send -r 666 "$(basename $0)" "$1"
}

abort() {
    RED='\033[0;31m'
    RESET='\033[0m'
    notify "$1"
    exit 1
}

notify_stop() {
    notify "Stopped on $output\n$source"
}

set_output() {
    wlr-randr \
        | grep '^[^[:space:]]'\
        | wmenu-color -p "[output] " -l 3 \
        | tr -d '()' \
        | cut -d' ' -f-1
}

set_source() {
    pw-dump \
        | grep "\"node.name\":" \
        | sort \
        | wmenu-color -p "[source] " -l 6 \
        | cut -d'"' -f4
}

start_capture() {
    output="$(set_output)"
    [ -z "$output" ] && abort "No output selected"

    source="$(set_source)"
    [ -z "$source" ] && notify "No audio source selected"

    notify "Capturing on $output\n$source"

    trap notify_stop EXIT INT TERM

    wf-recorder -r "$FPS" -o "$output" -a "$source" -f "${filename}.${extension}"
}

[ -z "$1" ] && start_capture
