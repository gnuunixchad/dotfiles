#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025
# use wmenu to select the screen and audio source for screen casting

FPS=30
CAPTURE_HOME="${HOME}/tmp/screencapture"
[ -d "$CAPTURE_HOME" ] || mkdir -p $CAPTURE_HOME

filename="${CAPTURE_HOME}/$(date +%Y-%m-%d-%H-%M-%S).mp4"

notifyStart() {
    notify-send -u low -r 1257 "$(basename "$0")" "on $output\n$source"
}

notifyStop() {
    notify-send -u low -r 1257 "$(basename "$0")" "stopped $output\n$source"
}

setOutput() {
    wlr-randr \
        | grep '^[^[:space:]]'\
        | wmenu-color -p "[output] " -l 3 \
        | tr -d '()' \
        | cut -d' ' -f-1
}

setSource() {
    pw-dump \
        | grep "\"node.name\":" \
        | sort \
        | wmenu-color -p "[source] " -l 6 \
        | cut -d'"' -f4
}

output="$(setOutput)"
[ -z "$output" ] && exit 0

source="$(setSource)"
[ -z "$source" ] && exit 0

notifyStart

trap notifyStop EXIT INT TERM

wf-recorder -r "$FPS" -o "$output" -a "$source" -f "$filename"
