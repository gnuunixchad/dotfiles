#!/usr/bin/sh
# @author nate zhou
# @since 2024,2025
# capture - select output and audio source for screen casting via danymic menu
# @depends wl-recorder, wmenu, libnotify

CAPTURE_HOME="${HOME}/tmp/capture"
[ -d "$CAPTURE_HOME" ] || mkdir -p $CAPTURE_HOME

fps=30
filename="${CAPTURE_HOME}/$(date +%Y-%m-%d_%H_%M_%S)"
extension="mp4"

usage() {
    cat <<_EOF_
USAGE
        $(basename $0) [OPTION]...
        Select output and audio source for screen casting via danymic menu.
        Default fomart is mp4 in 30FPS
OPTIONS
        -6,--60     record in 60FPS
        -m,--mkv    record in mkv
        -M,--mute   record without audio
_EOF_

exit 0
}

notify() {
    echo "${RED}${1}${RESET}"
    [ "$XDG_SESSION_TYPE" != "tty" ] && notify-send -r 666 "$(basename $0)" "$1"
}

abort() {
    RED='\033[0;31m'
    RESET='\033[0m'
    notify "$1"
    exit 1
}

notifyStop() {
    notify "Stopped on $output\n$source"
    exit 0
}

setOutput() {
    wlr-randr \
        | grep '^[^[:space:]]'\
        | wmenu-color -p "[output]" -l 3 \
        | tr -d '()' \
        | cut -d' ' -f-1
}

setSource() {
    pw-dump \
        | grep "\"node.name\":" \
        | sort \
        | wmenu-color -p "[source]" -l 6 \
        | cut -d'"' -f4
}

startCapture() {
    output="$(setOutput)"
    [ -z "$output" ] && abort "No output selected"

    if [ "$isMute" != "true" ]; then
        source="$(setSource)"
        [ -z "$source" ] && abort "No audio source selected"
        audioOption="-a '$source'"
    else
        notify "No audio source included"
        source=""
        audioOption=""
    fi

    notify "Capturing on $output\n$source"

    trap notifyStop EXIT INT TERM

    wf-recorder --framerate "$fps" \
                --output "$output" \
                "$audioOption" \
                -c h264_vaapi \
                -f "${filename}.${extension}"
}

[ -z "$1" ] && startCapture

while [ ! -z "$1" ]; do
    case "$1" in
        -6|--60) fps=60 ;;
        -m|--mkv) extension="mkv" ;;
        -M|--mute) isMute="true" ;;
        *) usage ;;
    esac
    shift
done && startCapture
