#!/usr/bin/sh
# @author nate zhou
# @since 2025
# encrypt the file with pulic key, using wmenu for key selection
# Also see `./gpg-cipher`

source ${HOME}/.local/bin/wmenu-color 2>/dev/null

usage() {
    cat << _EOF_
USAGE
        $(basename "$0") FILE

encrypt the file with pulic key, using wmenu for key selection
_EOF_
}

[ "$#" -eq 0 ] && (usage; exit 1)

gpg_pubkey=$(gpg --list-keys | sed -n 's/.*<\(.*\)>.*/\1/p' | wmenu-color -l 5 -P -p "[$(basename $0)] passphrase: ")

[ -z "$gpg_pubkey" ] && ( \
    notify-send -r 1285 -u low "$(basename $0):" "Aborted for null recipient"; \
    exit 1)

gpg --no-symkey-cache --recipient "$gpg_pubkey" --encrypt "$1" \
    && msg="encryption done" \
    || msg="encryption failed"

[ "$XDG_SESSION_TYPE" != "tty" ] \
    && notify-send -u low -r 1285 "$(basename $0)" "$msg"
