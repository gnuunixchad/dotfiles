# vim:ft=lf
# @author nate zhou
# @since 2025,2026
# lf/rifle.conf - file opener

cmd open &{{
    term="footclient"
    open_img() {
        # open files in the sorted order in lf
        local LIST="${XDG_RUNTIME_DIR}/rifle"
        ${HOME}/.config/lf/lf-rearrange.sh "$f"

        if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
            swayimg -F "$LIST" -o none
        elif [ -n "$XAUTHORITY" ]; then
            cat "$LIST" | nsxiv -
        else
            lf -remote "send $id \$mpv --playlist="$LIST" --playlist-start=0 \
                                       --loop-playlist"
        fi
    }

    case $(file --mime-type -Lb $f) in
        image/x-xcf)
            gimp $fx
            ;;
        image/*)
            open_img
            ;;
        video/*)
            LIST="${XDG_RUNTIME_DIR}/rifle"
            ${HOME}/.config/lf/lf-rearrange.sh "$f"
            [ "$XDG_SESSION_TYPE" != "tty" ] \
                && mpv --playlist="$LIST" --playlist-start=0 --loop-playlist \
                || lf -remote "send $id \$mpv --playlist="$LIST" \
                                              --playlist-start=0 \
                                              --loop-playlist"
            ;;
        audio/*)
            LIST="${XDG_RUNTIME_DIR}/rifle"
            ${HOME}/.config/lf/lf-rearrange.sh "$f"
            [ "$XDG_SESSION_TYPE" != "tty" ] \
                && "$term" mpv --playlist="$LIST" \
                                --playlist-start=0 --loop-playlist \
                || lf -remote "send $id \$mpv --playlist="$LIST" \
                                              --playlist-start=0 \
                                              --loop-playlist"

            ;;
        */pdf|*/epub*)
            if [ "$XDG_SESSION_TYPE" != "tty" ]; then
                zathura $f
            else
                lf -remote "send $id \$epr \$f"
            fi
            ;;
		application/*opendocument*|*officedocument*)
            libreoffice $fx
            ;;
        application/octet-stream)
            case "$f" in
                *.gpg)
                    lf -remote "send $id \$${HOME}/.local/bin/gpg-rifle \$f"
                    ;;
                *.mp3)
                    LIST="${XDG_RUNTIME_DIR}/rifle"
                    ${HOME}/.config/lf/lf-rearrange.sh "$f"
                    [ "$XDG_SESSION_TYPE" != "tty" ] \
                        && "$term" mpv --playlist="$LIST" \
                                       --playlist-start=0 --loop-playlist \
                                       --audio-display=no \
                        || lf -remote "send $id \$mpv --playlist="$LIST" \
                                                      --playlist-start=0 \
                                                      --loop-playlist" \
                                                      --audio-display=no \
                    ;;
                *)
                    lf -remote "send $id \$$EDITOR -p \$fx"
                    ;;
            esac
            ;;
        message/rfc822)
            [ "$XDG_SESSION_TYPE" != "tty" ] \
                && "$term" mutt -f "$(realpath $f | rev | cut -d'/' -f3- | rev)" \
                || lf -remote "send $id \$mutt -f "$(realpath \$f \
                                         | rev | cut -d'/' -f3- | rev)""
            ;;
        text/troff)
            lf -remote "send $id \$man -l \$f"
            ;;
        text/html)
            case "$f" in
                *.svg)
                    open_img
                    ;;
                *.md)
                    lf -remote "send $id \$$EDITOR -p \$fx"
                    ;;
                *)
                    [ "$XDG_SESSION_TYPE" != "tty" ] && $BROWSER $fx \
                    || lf -remote "send $id \$w3m \$fx"
                    ;;
            esac
            ;;
        text/*|*/json|inode/x-empty|application/javascript|application/mbox|application/pgp-signature|application/pgp-keys)
            case "$f" in
                *.svg)
                    open_img
                    ;;
                *)
                    lf -remote "send $id \$$EDITOR -p \$fx"
                    ;;
            esac
            ;;
        application/*)
            case "$f" in
                *.epub) # some epub's mime type is application/zip
                    if [ "$XDG_SESSION_TYPE" != "tty" ]; then
                        zathura $f
                    else
                        lf -remote "send $id \$epr \$f"
                    fi
                    ;;
                *)
                   lf -remote "send $id \$${HOME}/.local/bin/scope \$f"
                   ;;
            esac
            ;;
    esac
}}
